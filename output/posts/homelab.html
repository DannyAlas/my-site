<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homelab</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/code.css">
    <script src="/js/code.js"></script>
    <script src="https://kit.fontawesome.com/9c3c92ad15.js" crossorigin="anonymous"></script>
</head>
<body>
    
<nav
style="
background-color: var(--color-nav);
display: flex;
"
>
    <div id="nav-container" style="
    display: flex;
    justify-content: space-between;
    width: 100%;
    padding: 10px;
    margin: 0;
    ">
        <a href="/">
            <div class="logo">
                <img src="/imgs/june.png" alt="Jazzy Cloud Logo" id="june">
            </div>
        </a>
        <div id="menu">
            <ul class="nav-links" style="
            display: flex;
            list-style-type: none;
            margin-right: 10px;
            ">
                <li><a href="/posts">Posts</a>/</li>
                <li><a href="/about">Me?</a>/</li>
            </ul>
        </div>
    </div>
</nav>

    <header>
        <h1>Homelab</h1>
        <p>Posted by Danny on 2024-04-01</p>
    </header>
    <div id="post">
        <div id="toc">
            <div id="toc-title">
                <button id="toc-toggle"></button>
                Homelab
            </div>
            <div id="toc-content"></div>
        </div>
        <article id="contents">
            <h1>My Homelab for 2024</h1>
<p>This is more of a living document than a blog post and I'll keep editing and adding to it as things change. I thought about doing some version control, but hey, that's what git is for so <a href="https://github.com/DannyAlas/jazzy-cloud">here's</a> the link.</p>
<h1>The Physical</h1>
<h2>Nodes</h2>
<p><img src="/imgs/homelab/optiplex-7070.png" alt="Optiplexes" /></p>
<table>
<thead>
<tr>
<th align="center">Components</th>
<th align="center">Spec</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><i class="fa-solid fa-microchip"></i></td>
<td align="center">1x i7-9700 &amp; 3x i7-8700</td>
</tr>
<tr>
<td align="center"><i class="fa-solid fa-memory"></i></td>
<td align="center">93 GiB</td>
</tr>
<tr>
<td align="center"><i class="fa-solid fa-hard-drive"></i></td>
<td align="center">4x 256 SSD</td>
</tr>
<tr>
<td align="center"><i class="fa-solid fa-network-wired"></i></td>
<td align="center">4x Gigabit Intel NIC</td>
</tr>
<tr>
<td align="center"><i class="fa-solid fa-network-wired"></i></td>
<td align="center">4x 10Gigabit ConnectX3</td>
</tr>
<tr>
<td align="center"><i class="fa-brands fa-windows"></i></td>
<td align="center">pve/8.1.3/b46aac3b42da5d15</td>
</tr>
</tbody>
</table>
<h3>Zeus</h3>
<p><img src="/imgs/homelab/zeus.png" alt="Zeus" />
( I know, I know, I'm not good at naming things... )</p>
<table>
<thead>
<tr>
<th align="center">Components</th>
<th align="center">Spec</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><i class="fa-solid fa-microchip"></i></td>
<td align="center">1x  i7-6700K</td>
</tr>
<tr>
<td align="center"><i class="fa-solid fa-memory"></i></td>
<td align="center">32 GiB</td>
</tr>
<tr>
<td align="center"><i class="fa-solid fa-database"></i></td>
<td align="center">4x Seagate BarraCuda 4Tb Drive (RAIDZ1)</td>
</tr>
<tr>
<td align="center"><i class="fa-solid fa-hard-drive"></i></td>
<td align="center">2x 2Tb random Drives (Pool 2 - RAIDZ1)</td>
</tr>
<tr>
<td align="center"><i class="fa-solid fa-server"></i></td>
<td align="center">NVIDIA RTX 3050 (Patched drivers for transcoding)</td>
</tr>
<tr>
<td align="center"><i class="fa-solid fa-network-wired"></i></td>
<td align="center">1x Gigabit Intel NIC</td>
</tr>
<tr>
<td align="center"><i class="fa-solid fa-network-wired"></i></td>
<td align="center">1x 10Gigabit ConnectX3</td>
</tr>
<tr>
<td align="center"><i class="fa-brands fa-windows"></i></td>
<td align="center">pve/8.1.3/b46aac3b42da5d15</td>
</tr>
</tbody>
</table>
<p>I run the 4 Dell Optiplexes as <a href="https://www.proxmox.com/en/proxmox-virtual-environment/overview">Proxmox</a> nodes only, I bought them used for a really good deal.</p>
<p>The, original lab was mainly just Zeus but now he's the granddaddy of all my servers. He's been through more disasters than a Greek tragedy. Still, he acts an extra node in the Prox cluster, my NAS and and runs one of the K8s masters (mainly for graphics related processes). I used to run TrueNas Scale for the NAS but moved to just a Debian ZFS as I didn't need most of the things it provided.</p>
<p><img src="/imgs/homelab/prox-webui.png" alt="Proxmox Web Ui" /></p>
<p>Thus it's a <strong>5 node cluster</strong>, with local with lvm thins on a each host. I'm experimenting with Ceph and HA but don't have enough OSDs for now to be production ready. Availability is mainly L7 based, but there are a few VMs in the Prox HA.</p>
<p>I run <a href="https://www.debian.org/">Debian</a> wherever possible and also use it as my daily driver for my PC and laptop.</p>
<p>I use two separate bridges for networking, one with the gigabit cards for all VMs, LXCs (these are being moved to K8s), WebUI, and corosync. Then the 10G cards are on a separate bridge, no LACP. This is reserved for the Kubernetes cluster and Ceph/storage bandwidth. I setup spanning tree on the Mikrotik's so I can loose one cable and still be able to reach every node.</p>
<h2>Networking</h2>
<p><img src="/imgs/homelab/network-diagram.png" alt="Homelab Network" /></p>
<h3>Router/Firewall</h3>
<p>I have a fiber gigabit uplink to my ISP going into my main <strong>firewall</strong> <a href="https://protectli.com/product/fw4b/">Protectli Vault FW4B</a> running PfSense in HA. I run the secondary instance on Zeus and even though pfsync is enabled, the WAN switch currently only terminates to the Protectli. Thus, I don't route any traffic through Zeus at the moment but if needed I could manually move over the WAN link.</p>
<p>By default everything is rejected both ways, I only open ports to the metallb IPs for my Istio Gateways and I control ingress/egress though them. I also run Snort and have done a lot of <em>finagling</em> to get it working nicely, though it's never perfect. There are also three VPNs running, a Wireguard for personal uses and an OpenVPN server setup because a <a href="https://support.torproject.org/abuse/what-about-ddos/#:~:text=But%20because%20Tor%20only%20transports%20correctly%20formed%20TCP%20streams%2C%20not%20all%20IP%20packets%2C%20you%20cannot%20send%20UDP%20packets%20over%20Tor">specific type of network traffic</a> only allows TCP streams which <a href="https://www.wireguard.com/known-limitations/#:~:text=WireGuard%20explicitly%20does%20not%20support%20tunneling%20over%20TCP">Wiregaurd doesn't support</a>. And lastly a Wiregaurd for my Work <strong>and only work</strong> traffic. My goal in the future is to get another fully dedicated firewall box for proper HA.</p>
<h4>SW1 Core switch : MikroTik CRS309-1G-8S+IN</h4>
<p><img src="/imgs/homelab/mikrotik-CRS309-1G-8S+IN.webp" alt="" /></p>
<p>Nothing fancy, just running SwitchOS.</p>
<h4>SW2: W.I.P. about to be CRS326-24G-2S+RM</h4>
<p>coming very soon...</p>
<h4>AP</h4>
<p><img src="/imgs/homelab/WAX214PA.png" alt="" /></p>
<p>Only one Access Point with 3 SSID, LAN, GUESTS and IOT.</p>
<h3>VLANS</h3>
<ul>
<li>LAN : Most <em>trusted things</em> are in here.</li>
<li>IOT : smart tv, smart light bulbs, and anything I do not trust.</li>
<li>GUEST : This one is for the GUEST Wifi and only provides WAN access.</li>
<li>LARGE : PVE, PBS and the ZFS NAS and other storage is here</li>
<li>ADMIN : Switches, AP, PBS &amp; PVE Webui, SSH, secure VPN traffic, etc.</li>
<li>CLUSTER: Corosync</li>
</ul>
<h1>Base services</h1>
<h2>DNS...</h2>
<p>I use two PiHoles for DNS filtering / blacklisting, two <a href="https://doc.powerdns.com/recursor/">PowerDNS Recursors</a> and two <a href="https://doc.powerdns.com/authoritative/">PowerDNS Authoritative Servers</a> connected to my PostgreSQL DB in the K8S cluster.</p>
<p><img src="/imgs/homelab/home-dns-infra-dark-background.png" alt="" /></p>
<p>Kea DHCP in my PfSense router pushes the two PiHoles to my clients, servers are using the re-cursors directly.</p>
<p>The PowerDNS solution is pretty overkill for my needs but it was a good learning experiance and if one of my VMs is ever down, at least my DNS stays running :). I can mess around a lot with routing and gather a good bit of metrics with this set up! I've also been using <a href="https://github.com/PowerDNS-Admin/PowerDNS-Admin">PowerDNS Admin</a> as a nice way to manage the records.</p>
<h2>Git + Ops</h2>
<p>Forgejo, Jenkins, and Harbor! All running in the K8S cluster. I'm slowly moving my projects to being hosted on Forgio and just mirrored to GitHub.</p>
<h2>Kubernetes</h2>
<p>Set up through some custome Ansible playbooks which was crucial while learning cause sure messed up a lot. Everything is configured with FluxCD (Lens is great b.t.w.). Initially I used Rancher + Helm charts for deployments but as complexity grew, I quickly learned why GitOps is nice.</p>
<p>This is still a W.I.P... I'll have a detailed write up about everything running in the future but as a simple overview for what hosted right now.</p>
<ul>
<li>Metallb</li>
<li>Istio</li>
<li>NFS Provisioner</li>
<li>Longhorn</li>
<li>Cloud Native Postgres (2x)</li>
<li>KeyDB</li>
<li>Kafka</li>
<li>Minio</li>
<li>Prometheus</li>
<li>Grafana</li>
<li>Loki</li>
<li>Promtail</li>
<li>Keycloak</li>
<li>Hashicorp Vault</li>
<li>*Arrs stack + Qbt + Plex (I use my own operator for this, based on <a href="https://github.com/kubealex/k8s-mediaserver-operator">this wonderful project</a>, I might release mine as public soon as it configures with Postgress for everything, even Qbt)</li>
<li>Forgejo</li>
<li>Harbor</li>
<li>Airflow</li>
<li>Flyte</li>
<li>Jenkins</li>
<li>Then all of my personal web services (this site, APIs, scrapers, etc. I'll also go into these more in the future)</li>
</ul>

        </article>
    </div>
    
<footer>
    <div>
        <p>&copy; 2024 Daniel Alas (Jazzy Cloud)</p>
    </div>
</footer>

</body>
    <script src="/js/index.js"></script>
    <script >
        var tocPadding = 40
        
        document.getElementById('toc-toggle').addEventListener('click', function () {
            var tocContent = document.getElementById('toc-content');
            var tocContent = document.getElementById('toc-content');
            tocContent.classList.toggle('open'); 
            this.classList.toggle('opened'); 
            if (tocContent.classList.contains('open')) {
                tocContent.style.maxHeight = `calc(100vh - ${tocPadding}px)`; 
            } else {
                tocContent.style.maxHeight = '0'; 
            }
        });
        function adjustTOC() {
            var contents = document.getElementById('contents');
            var toc = document.getElementById('toc');
            
            
            var contentRect = contents.getBoundingClientRect();
            var tocPadding = 40
            var leftEdge = contentRect.right + tocPadding
            var availableWidth = window.innerWidth - leftEdge - tocPadding

            toc.style.left = `${leftEdge}px`; 
            toc.style.width = `${availableWidth}px`; 
            toc.style.top = `${contents.offsetTop}px`;
        }
        function handleScroll() {
            
            var toc = document.getElementById('toc');
            var contents = document.getElementById('contents');
            
            if (contents.getBoundingClientRect().top < 0 + tocPadding) {
                toc.style.position = 'fixed';
                toc.style.top = `${tocPadding}px`;
            } else {
                toc.style.position = 'absolute';
                toc.style.top = `${contents.offsetTop}px`;
            }
        }
        function makeToc() {
            var toc = "";
            var level = 0;
            document.getElementById("contents").innerHTML =
                document.getElementById("contents").innerHTML.replace(
                    /<h([\d])>([^<]+)<\/h([\d])>/gi,
                    function (str, openLevel, titleText, closeLevel) {
                        if (openLevel != closeLevel) {
                            return str;
                        }
                        if (openLevel > level) {
                            toc += (new Array(openLevel - level + 1)).join("<ul>");
                        } else if (openLevel < level) {
                            toc += (new Array(level - openLevel + 1)).join("</ul>");
                        }
                        level = parseInt(openLevel);
                        var anchor = titleText.replace(/ /g, "_");
                        toc += "<li><a href=\"#" + anchor + "\">" + titleText
                            + "</a></li>";
                        return "<h" + openLevel + "><a name=\"" + anchor + "\">"
                            + titleText + "</a></h" + closeLevel + ">";
                    }
                );
            if (level) {
                toc += (new Array(level + 1)).join("</ul>");
            }
            document.getElementById("toc-content").innerHTML += toc;
        }
        
        window.onload = function () {
            makeToc();
            adjustTOC();
        };
        adjustTOC();
        window.addEventListener('scroll', handleScroll); 
        window.addEventListener('resize', adjustTOC); 
    </script> 
</html>
